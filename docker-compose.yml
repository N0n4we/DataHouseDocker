services:

  streampark:
    image: apache/streampark:v2.1.5
    hostname: streampark
    container_name: streampark
    ports:
      - "10001:10000"
    environment:
      TZ: Asia/Shanghai
      DATASOURCE_DIALECT: h2
    networks:
      - single-node-network

  dolphinscheduler:
    image: apache/dolphinscheduler-standalone-server:latest
    hostname: dolphinscheduler
    container_name: dolphinscheduler
    ports:
      - "12345:12345"
      - "25333:25333"
    networks:
      - single-node-network

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    hostname: zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - single-node-network

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    hostname: kafka
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # 双监听器
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:29092,EXTERNAL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://localhost:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - single-node-network

  postgresql:
    image: postgres:15
    hostname: postgresql
    container_name: postgresql
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      # Note: Ensure your init-postgres.sql creates the databases 'superset' and 'metastore'
    volumes:
      - ./init-postgres.sql:/docker-entrypoint-initdb.d/init-postgres.sql
    networks:
      - single-node-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  flink-jobmanager:
    image: flink:1.17-scala_2.12
    hostname: flink-jobmanager
    container_name: flink-jobmanager
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
    volumes:
      - hive_warehouse:/opt/hive/data/warehouse
    networks:
      - single-node-network

  flink-taskmanager:
    image: flink:1.17-scala_2.12
    hostname: flink-taskmanager
    container_name: flink-taskmanager
    depends_on:
      - flink-jobmanager
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 24
    volumes:
      - hive_warehouse:/opt/hive/data/warehouse
    networks:
      - single-node-network

  hive-metastore:
    build:
      context: .
      dockerfile: hive.Dockerfile
    hostname: hive-metastore
    container_name: hive-metastore
    depends_on:
      postgresql:
        condition: service_healthy
    ports:
      - "9083:9083"
    environment:
      SERVICE_NAME: metastore
    volumes:
      - hive_warehouse:/opt/hive/data/warehouse
      - ./hive-site.xml:/opt/hive/conf/hive-site.xml:ro
    networks:
      - single-node-network
    healthcheck:
      test: ["CMD", "bash", "-c", "nc -z localhost 9083"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s

  hive:
    build:
      context: .
      dockerfile: hive.Dockerfile
    hostname: hive
    container_name: hive
    depends_on:
      hive-metastore:
        condition: service_healthy
    ports:
      - "10000:10000"    # HiveServer2 Thrift
      - "10002:10002"    # HiveServer2 WebUI
    environment:
      SERVICE_NAME: hiveserver2
    volumes:
      - hive_warehouse:/opt/hive/data/warehouse
      - ./hive-site.xml:/opt/hive/conf/hive-site.xml:ro
      - ./hive-env.sh:/opt/hive/conf/hive-env.sh:ro
    networks:
      - single-node-network

  hbase-master:
    image: dajobe/hbase
    hostname: hbase-master
    container_name: hbase-master
    depends_on:
      - zookeeper
    ports:
      - "16000:16000"
      - "16010:16010"
    environment:
      HBASE_MANAGES_ZK: "false"
      HBASE_ZOOKEEPER_QUORUM: zookeeper
    networks:
      - single-node-network

  redis:
    image: redis:7-alpine
    hostname: redis
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - single-node-network

  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    hostname: clickhouse
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
      - "9004:9004"
    networks:
      - single-node-network

  superset:
    build:
      context: .
      dockerfile: superset.Dockerfile
    hostname: superset
    container_name: superset
    ports:
      - "8088:8088"
    depends_on:
      superset-init:
        condition: service_completed_successfully
    environment:
      SUPERSET_SECRET_KEY: "your-secret-key-change-me"
      SQLALCHEMY_DATABASE_URI: postgresql://postgres:password@postgresql:5432/superset
      SUPERSET_CONFIG_PATH: /app/superset_home/superset_config.py
    # ADD THIS SECTION:
    volumes:
      - superset_home:/app/superset_home
    networks:
      - single-node-network

  superset-init:
    build:
      context: .
      dockerfile: superset.Dockerfile
    container_name: superset-init
    depends_on:
      postgresql:
        condition: service_healthy
    environment:
      SUPERSET_SECRET_KEY: "your-secret-key-change-me"
      SQLALCHEMY_DATABASE_URI: postgresql://postgres:password@postgresql:5432/superset
      SUPERSET_CONFIG_PATH: /app/superset_home/superset_config.py
    # ADD THIS SECTION:
    volumes:
      - superset_home:/app/superset_home
    command: >
      bash -c "
      echo 'import os' > /app/superset_home/superset_config.py &&
      echo 'SQLALCHEMY_DATABASE_URI = os.getenv(\"SQLALCHEMY_DATABASE_URI\")' >> /app/superset_home/superset_config.py &&
      echo 'SECRET_KEY = os.getenv(\"SUPERSET_SECRET_KEY\")' >> /app/superset_home/superset_config.py &&
      superset fab create-admin --username admin --firstname Superset --lastname Admin --email admin@superset.com --password admin &&
      superset db upgrade &&
      superset init
      "
    networks:
      - single-node-network

volumes:
  superset_home:
  hive_warehouse:

networks:
  single-node-network:
    name: biliback
    driver: bridge
